<?xml version="1.0"?>
<!DOCTYPE modification SYSTEM "http://www.simplemachines.org/xml/modification">
<!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
	This is an example modification file for SMF packages.

	ATTENTION: If you are trying to install this manually, you should try
	the package manager.  If it will not work for you, please take a look
	at the following for information on this format:
		http://mods.simplemachines.org/docs/manual-install.php

================================================================================

	Modification files can be used to modify files so that they do what
	your package needs them to do to work properly.

 - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->

<modification xmlns="http://www.simplemachines.org/xml/modification" xmlns:smf="http://www.simplemachines.org/">
	<id>smf:test</id>
	<version>1</version>
	<file name="$boarddir/index.php">
		<operation>
			<search position="replace"><![CDATA[* Software Version:           SMF 1.1.11                                          *
]]></search>
			<add><![CDATA[* Software Version:           SMF 1.1.12                                          *
]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[$forum_version = 'SMF 1.1.11';
]]></search>
			<add><![CDATA[$forum_version = 'SMF 1.1.12';
]]></add>
		</operation>
	</file>
	<file name="$sourcedir/DumpDatabase.php">
		<operation>
			<search position="replace"><![CDATA[* Software Version:           SMF 1.1                                             *
]]></search>
			<add><![CDATA[* Software Version:           SMF 1.1.12                                             *
]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[	@ini_set('memory_limit', '128M');
]]></search>
			<add><![CDATA[	if (@ini_get('memory_limit') < 256)
		@ini_set('memory_limit', '256M');
]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[		header('Content-Type: application/octetstream');
]]></search>
			<add><![CDATA[		header('Content-Type: ' . ($context['browser']['is_ie'] || $context['browser']['is_opera'] ? 'application/octetstream' : 'application/octet-stream'));
]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[	// Probably MyISAM.... and it might have a comment.
]]></search>
			<add><![CDATA[	// MySQL users below 4.0 can not use Engine
	if (version_compare('4', preg_replace('~\-.+?$~', '', min(mysql_get_server_info(), mysql_get_client_info()))) > 0)
		$schema_type = 'TYPE=';
	else 
		$schema_type = 'ENGINE=';
	
]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[	$schema_create .= $crlf . ') TYPE=' . (isset($row['Type']) ? $row['Type'] : $row['Engine']) . ($row['Comment'] != '' ? ' COMMENT="' . $row['Comment'] . '"' : '');
]]></search>
			<add><![CDATA[	$schema_create .= $crlf . ') ' . $schema_type . (isset($row['Type']) ? $row['Type'] : $row['Engine']) . ($row['Comment'] != '' ? ' COMMENT="' . $row['Comment'] . '"' : '');
]]></add>
		</operation>
	</file>
	<file name="$sourcedir/ManageSearch.php">
		<operation>
			<search position="replace"><![CDATA[* Software Version:           SMF 1.1.2                                           *
]]></search>
			<add><![CDATA[* Software Version:           SMF 1.1.12                                           *
]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[			db_query("
				CREATE TABLE {$db_prefix}log_search_words (
					ID_WORD " . $index_properties[$context['index_settings']['bytes_per_word']]['column_definition'] . " unsigned NOT NULL default '0',
					ID_MSG int(10) unsigned NOT NULL default '0',
					PRIMARY KEY (ID_WORD, ID_MSG)
]]></search>
			<add><![CDATA[			// MySQL users below 4.0 can not use Engine
			if (version_compare('4', preg_replace('~\-.+?$~', '', min(mysql_get_server_info(), mysql_get_client_info()))) > 0)
				$schema_type = 'TYPE=';
			else
				$schema_type = 'ENGINE=';

]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[				) TYPE=MyISAM", __FILE__, __LINE__);
			
]]></search>
			<add><![CDATA[				) " . $schema_type . "MyISAM", __FILE__, __LINE__);

]]></add>
		</operation>
	</file>
	<file name="$sourcedir/ManageSmileys.php">
		<operation>
			<search position="replace"><![CDATA[* Software Version:           SMF 1.1.11                                          *
]]></search>
			<add><![CDATA[* Software Version:           SMF 1.1.12                                          *
]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[*/

function ManageSmileys()
]]></search>
			<add><![CDATA[
	void EditMessageIcons()
		// !!!

	void sortSmileyTable()
		// !!!
]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[		updateSettings(array(
			'smiley_sets_default' => empty($context['smiley_sets'][$_POST['default_smiley_set']]) ? 'default' : $context['smiley_sets'][$_POST['default_smiley_set']],
			'smiley_sets_enable' => isset($_POST['smiley_sets_enable']) ? '1' : '0',
]]></search>
			<add><![CDATA[		// Make sure that the smileys are in the right order after enabling them.
		if (isset($_POST['smiley_enable']))
			sortSmileyTable();

]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[			db_query("
				ALTER TABLE {$db_prefix}smileys
				ORDER BY LENGTH(code) DESC", __FILE__, __LINE__);
]]></search>
			<add><![CDATA[			sortSmileyTable();
]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[		db_query("
			ALTER TABLE {$db_prefix}smileys
			ORDER BY LENGTH(code) DESC", __FILE__, __LINE__);
]]></search>
			<add><![CDATA[		sortSmileyTable();
]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[?>
]]></search>
			<add><![CDATA[// This function sorts the smiley table by code length, it is needed as MySQL withdrew support for functions in order by.
function sortSmileyTable()
{
	global $db_prefix;

	// Add a sorting column.
	db_query("
		ALTER TABLE {$db_prefix}smileys
		ADD temp_order mediumint(8) not null", __FILE__, __LINE__);

	// Set the contents of this column.
	db_query("
		UPDATE {$db_prefix}smileys
		SET temp_order = LENGTH(code)", __FILE__, __LINE__);

	// Order the table by this column.
	db_query("
		ALTER TABLE {$db_prefix}smileys
		ORDER BY temp_order DESC", __FILE__, __LINE__);

	// Remove the sorting column.
	db_query("
		ALTER TABLE {$db_prefix}smileys
		DROP temp_order", __FILE__, __LINE__);
}

]]></add>
		</operation>
	</file>
	<file name="$sourcedir/News.php">
		<operation>
			<search position="replace"><![CDATA[* Software Version:           SMF 1.1                                             *
]]></search>
			<add><![CDATA[* Software Version:           SMF 1.1.12                                             *
]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[	// Find the most recent members.
	$request = db_query("
		SELECT ID_MEMBER, memberName, realName, dateRegistered, lastLogin
]]></search>
			<add><![CDATA[	if (!allowedTo('view_mlist'))
		return array();

]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[	if (!loadMemberContext($_GET['u']))
]]></search>
			<add><![CDATA[	if (!loadMemberContext($_GET['u']) || !allowedTo('profile_view_any'))
]]></add>
		</operation>
	</file>
	<file name="$sourcedir/PackageGet.php">
		<operation>
			<search position="replace"><![CDATA[* Software Version:           SMF 1.1.11                                          *
]]></search>
			<add><![CDATA[* Software Version:           SMF 1.1.12                                          *
]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[			'name' => htmlspecialchars($row['name']),
			'url' => htmlspecialchars($row['url']),
]]></search>
			<add><![CDATA[			'name' => $row['name'],
			'url' => $row['url'],
]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[		
]]></search>
			<add><![CDATA[
]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[		
]]></search>
			<add><![CDATA[
]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[			
]]></search>
			<add><![CDATA[
]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[					$package['description'] = parse_bbc(preg_replace('~\[[/]?html\]~i', '', htmlspecialchars($package['description'])));				
]]></search>
			<add><![CDATA[					$package['description'] = parse_bbc(preg_replace('~\[[/]?html\]~i', '', htmlspecialchars($package['description'])));
]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[		
]]></search>
			<add><![CDATA[
]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
]]></search>
			<add><![CDATA[	$servername = htmlspecialchars($_POST['servername']);
	$serverurl = htmlspecialchars($_POST['serverurl']);
	
	// Make sure the URL has the correct prefix.
	if (strpos($serverurl, 'http://') !== 0 && strpos($serverurl, 'https://') !== 0)
		$serverurl = 'http://' . $serverurl;
	
]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[		VALUES (SUBSTRING('$_POST[servername]', 1, 255), SUBSTRING('$_POST[serverurl]', 1, 255))", __FILE__, __LINE__);
]]></search>
			<add><![CDATA[		VALUES (SUBSTRING('$servername', 1, 255), SUBSTRING('$serverurl', 1, 255))", __FILE__, __LINE__);
]]></add>
		</operation>
	</file>
	<file name="$sourcedir/Subs-Package.php">
		<operation>
			<search position="replace"><![CDATA[* Software Version:           SMF 1.1.5                                           *
]]></search>
			<add><![CDATA[* Software Version:           SMF 1.1.12                                           *
]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[
]]></search>
			<add><![CDATA[		$lower = explode('.', $lower);
		$upper = explode('.', $upper);
		$version = explode('.', $version);
]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[		if (trim($lower) <= $version && trim($upper) >= $version)
			return true;
]]></search>
			<add><![CDATA[		foreach ($upper as $key => $high)
		{
			// Let's check that this is at or below the upper... obviously.
			if (isset($version[$key]) && trim($version[$key]) > trim($high))
				return false;

			// OK, let's check it's above the lower key... if it exists!
			if (isset($lower[$key]))
			{
				// The version either needs to have something here (i.e. can't be 1.0 on a 1.0.11) AND needs to be greater or equal to.
				// Note that if it's a range lower[key] might be blank, in that case version can not be set!
				if (!empty($lower[$key]) && (!isset($version[$key]) || trim($version[$key]) < trim($lower[$key])))
					return false;
			}
		}
		return true;
]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[	preg_match('~^(http|ftp)(s)?://([^/:]+)(:(\d))?(.+)$~', $url, $match);
]]></search>
			<add><![CDATA[	preg_match('~^(http|ftp)(s)?://([^/:]+)(:(\d+))?(.+)$~', $url, $match);
]]></add>
		</operation>
	</file>
	<file name="Themes/babylon/Display.template.php">
		<operation>
			<search position="replace"><![CDATA[// Version: 1.1; Display
]]></search>
			<add><![CDATA[// Version: 1.1.12; Display
]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[		$moderationButtons[] = '<a href="' . $scripturl . '?action=removepoll;topic=' . $context['current_topic'] . '.' . $context['start'] . '" onclick="return confirm(\'' . $txt['poll_remove_warn'] . '\');">' . ($settings['use_image_buttons'] ? '<img src="' . $settings['images_url'] . '/' . $context['user']['language'] . '/admin_remove_poll.gif" alt="' . $txt['poll_remove'] . '" border="0" />' : $txt['poll_remove']) . '</a>';
]]></search>
			<add><![CDATA[		$moderationButtons[] = '<a href="' . $scripturl . '?action=removepoll;topic=' . $context['current_topic'] . '.' . $context['start'] . ';sesc=' . $context['session_id'] . '" onclick="return confirm(\'' . $txt['poll_remove_warn'] . '\');">' . ($settings['use_image_buttons'] ? '<img src="' . $settings['images_url'] . '/' . $context['user']['language'] . '/admin_remove_poll.gif" alt="' . $txt['poll_remove'] . '" border="0" />' : $txt['poll_remove']) . '</a>';
]]></add>
		</operation>
	</file>
	<file name="Themes/classic/Display.template.php">
		<operation>
			<search position="replace"><![CDATA[// Version: 1.1; Display
]]></search>
			<add><![CDATA[// Version: 1.1.12; Display
]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[		$moderationButtons[] = '<a href="' . $scripturl . '?action=removepoll;topic=' . $context['current_topic'] . '.' . $context['start'] . '" onclick="return confirm(\'' . $txt['poll_remove_warn'] . '\');">' . ($settings['use_image_buttons'] ? '<img src="' . $settings['images_url'] . '/' . $context['user']['language'] . '/admin_remove_poll.gif" alt="' . $txt['poll_remove'] . '" border="0" />' : $txt['poll_remove']) . '</a>';
]]></search>
			<add><![CDATA[		$moderationButtons[] = '<a href="' . $scripturl . '?action=removepoll;topic=' . $context['current_topic'] . '.' . $context['start'] . ';sesc=' . $context['session_id'] . '" onclick="return confirm(\'' . $txt['poll_remove_warn'] . '\');">' . ($settings['use_image_buttons'] ? '<img src="' . $settings['images_url'] . '/' . $context['user']['language'] . '/admin_remove_poll.gif" alt="' . $txt['poll_remove'] . '" border="0" />' : $txt['poll_remove']) . '</a>';
]]></add>
		</operation>
	</file>
	<file name="$themedir/Admin.template.php">
		<operation>
			<search position="replace"><![CDATA[// Version: 1.1.1; Admin
]]></search>
			<add><![CDATA[// Version: 1.1.12; Admin
]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[			function smfDetermineVersions()
			{
				var highYour = {"Sources": "??", "Default" : "??", "Languages": "??", "Templates": "??"};
]]></search>
			<add><![CDATA[			function compareVersions(current, target)
			{
				// Are they equal, maybe?
				if (current == target)
					return false;

				var currentVersion = current.split(".");
				var targetVersion = target.split(".");

				for (var i = 0, n = (currentVersion.length > targetVersion.length ? currentVersion.length : targetVersion.length); i < n; i++)
				{
					// Make sure both are set.
					if (typeof(currentVersion[i]) == "undefined")
						currentVersion[i] = "0";
					else if (typeof(targetVersion[i]) == "undefined")
						targetVersion[i] = "0";

					// If they are same, move to the next set.
					if (currentVersion[i] == targetVersion[i])
						continue;
					// Otherwise a simple comparison...
					else
						return (parseInt(currentVersion[i]) < parseInt(targetVersion[i]));
				}

				return false;
			}

]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[						if ((highYour[versionType] < yourVersion || highYour[versionType] == "??") && !lowVersion[versionType])
]]></search>
			<add><![CDATA[						if ((compareVersions(highYour[versionType], yourVersion) || highYour[versionType] == "??") && !lowVersion[versionType])
]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[						if (highCurrent[versionType] < smfVersions[filename] || highCurrent[versionType] == "??")
]]></search>
			<add><![CDATA[						if (compareVersions(highCurrent[versionType], smfVersions[filename]) || highCurrent[versionType] == "??")
]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[						if (yourVersion < smfVersions[filename])
]]></search>
			<add><![CDATA[						if (compareVersions(yourVersion, smfVersions[filename]))
]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[					else if (yourVersion < smfVersions[filename])
]]></search>
			<add><![CDATA[					else if (compareVersions(yourVersion, smfVersions[filename]))
]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[						if ((highYour["Languages"] < yourVersion || highYour["Languages"] == "??") && !lowVersion["Languages"])
]]></search>
			<add><![CDATA[						if ((compareVersions(highYour["Languages"], yourVersion) || highYour["Languages"] == "??") && !lowVersion["Languages"])
]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[						if (highCurrent["Languages"] < smfLanguageVersions[filename] || highCurrent["Languages"] == "??")
]]></search>
			<add><![CDATA[						if (compareVersions(highCurrent["Languages"], smfLanguageVersions[filename]) || highCurrent["Languages"] == "??")
]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[						if (yourVersion < smfLanguageVersions[filename])
]]></search>
			<add><![CDATA[						if (compareVersions(yourVersion, smfLanguageVersions[filename]))
]]></add>
		</operation>
	</file>
	<file name="$themedir/Display.template.php">
		<operation>
			<search position="replace"><![CDATA[// Version: 1.1; Display
]]></search>
			<add><![CDATA[// Version: 1.1.12; Display
]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[		'remove_poll' => array('test' => 'can_remove_poll', 'text' => 'poll_remove', 'image' => 'admin_remove_poll.gif', 'lang' => true, 'custom' => 'onclick="return confirm(\'' . $txt['poll_remove_warn'] . '\');"', 'url' => $scripturl . '?action=removepoll;topic=' . $context['current_topic'] . '.' . $context['start']),
]]></search>
			<add><![CDATA[		'remove_poll' => array('test' => 'can_remove_poll', 'text' => 'poll_remove', 'image' => 'admin_remove_poll.gif', 'lang' => true, 'custom' => 'onclick="return confirm(\'' . $txt['poll_remove_warn'] . '\');"', 'url' => $scripturl . '?action=removepoll;topic=' . $context['current_topic'] . '.' . $context['start'] . ';sesc=' . $context['session_id']),
]]></add>
		</operation>
	</file>
</modification>
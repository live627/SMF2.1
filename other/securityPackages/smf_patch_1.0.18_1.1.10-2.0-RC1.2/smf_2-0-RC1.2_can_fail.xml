<modification xmlns="http://www.simplemachines.org/xml/modification" xmlns:smf="http://www.simplemachines.org/">
	<id>smf:smf-1.1.10</id>
	<version>1.1</version>

	<file name="$sourcedir/Subs.php" error="skip">
		<operation error="ignore">
			<search position="replace"><![CDATA[
		$path = $modSettings['attachmentUploadDir'][$modSettings['attachmentUploadDir']];
]]></search>
			<add><![CDATA[
		$path = $modSettings['attachmentUploadDir'][$dir];
]]></add>
		</operation>
	</file>

	<file name="$sourcedir/Subs-Graphics.php" error="skip">
		<operation error="ignore">
			<search position="replace"><![CDATA[
	$avatar_hash = empty($modSettings['custom_avatar_enabled']) ? getAttachmentFilename($destName, false, null, true) : null;
]]></search>
			<add><![CDATA[
	$avatar_hash = empty($modSettings['custom_avatar_enabled']) ? getAttachmentFilename($destName, false, null, true) : '';
]]></add>
		</operation>

		<operation error="ignore">
			<search position="replace"><![CDATA[
			while (!feof($fp2))
				fwrite($fp, fread($fp2, 8192));
			fclose($fp2);

			// Though not an exhaustive list, better safe than sorry.
			if (preg_match('~(iframe|\\<\\?php|\\<\\?|\\<%|html|eval|body|script)~', $destName) === 1)
			{
				unlink($destName);
				return false;
			}
]]></search>
			<add><![CDATA[
			$prev_chunk = '';
			while (!feof($fp2))
			{
				$cur_chunk = fread($fp2, 8192);

				// Make sure nothing odd came through.
				if (preg_match('~(iframe|\\<\\?php|\\<\\?[\s=]|\\<%[\s=]|html|eval|body|script\W)~', $prev_chunk . $cur_chunk) === 1)
				{
					fclose($fp2);
					fclose($fp);
					unlink($destName);
					return false;
				}

				fwrite($fp, $cur_chunk);
				$prev_chunk = $cur_chunk;
			}
			fclose($fp2);
]]></add>
		</operation>

		<operation error="ignore">
			<search position="replace"><![CDATA[
		// Walk the right path.		if (!empty($modSettings['currentAttachmentUploadDir']))
]]></search>
			<add><![CDATA[
		// Walk the right path.
		if (!empty($modSettings['currentAttachmentUploadDir']))
]]></add>
		</operation>

		<operation error="ignore">
			<search position="replace"><![CDATA[
		if (rename($destName . '.tmp', $avatar_hash === null ? $destName : $path . '/' . $attachID . '_' . $avatar_hash))
		{
]]></search>
			<add><![CDATA[
		if (rename($destName . '.tmp', empty($avatar_hash) ? $destName : $path . '/' . $attachID . '_' . $avatar_hash))
		{
			$destName = empty($avatar_hash) ? $destName : $path . '/' . $attachID . '_' . $avatar_hash;
]]></add>
		</operation>

		<operation error="ignore">
			<search position="replace"><![CDATA[
					'filesize' => filesize($avatar_hash === null ? $destName : $path . '/' . $attachID . '_' . $avatar_hash),
]]></search>
			<add><![CDATA[
					'filesize' => filesize($destName),
]]></add>
		</operation>
	</file>


	<file name="$sourcedir/Profile-Modify.php" error="skip">
		<operation error="ignore">
			<search position="replace"><![CDATA[
					$destinationPath = $uploadDir . '/' . ($file_hash === null ? $destName : $cur_profile['id_attach'] . '_' . $file_hash);
				if (!rename($_FILES['attachment']['tmp_name'], $destinationPath))
				{
					removeAttachments(array('id_member' => $memID));
					fatal_lang_error('attach_timeout', 'critical');
				}

				// Attempt to chmod it.
					@chmod($uploadDir . '/avatar_tmp_' . $memID, 0644);
]]></search>
			<add><![CDATA[
					// Attempt to chmod it.
					@chmod($uploadDir . '/avatar_tmp_' . $memID, 0644);
]]></add>
		</operation>

		<operation error="ignore">
			<search position="replace"><![CDATA[
					if (preg_match('~(iframe|\\<\\?php|\\<\\?|\\<%|html|eval|body|script)~', fgets($fp, 4096)) === 1)
]]></search>
			<add><![CDATA[
					if (preg_match('~(iframe|\\<\\?php|\\<\\?[\s=]|\\<%[\s=]|html|eval|body|script\W)~', fgets($fp, 4096)) === 1)
]]></add>
		</operation>

		<operation error="ignore">
			<search position="replace"><![CDATA[
						fatal_lang_error('smf124');
]]></search>
			<add><![CDATA[
						fatal_lang_error('attach_timeout');
]]></add>
		</operation>

		<operation error="ignore">
			<search position="replace"><![CDATA[
				$mime_type = 'image/' . ($extension == 'jpg' ? 'jpeg' : $extension);
]]></search>
			<add><![CDATA[
				$mime_type = 'image/' . ($extension === 'jpg' ? 'jpeg' : ($extension === 'bmp' ? 'x-ms-bmp' : $extension));
]]></add>
		</operation>

		<operation error="ignore">
			<search position="replace"><![CDATA[
				$file_hash = empty($modSettings['custom_avatar_enabled']) ? getAttachmentFilename($destName, false, null, true) : null;
]]></search>
			<add><![CDATA[

				$file_hash = empty($modSettings['custom_avatar_enabled']) ? getAttachmentFilename($destName, false, null, true) : '';
]]></add>
		</operation>

		<operation error="ignore">
			<search position="replace"><![CDATA[
				// Remove previous attachments this member might have had.
				removeAttachments(array('id_member' => $memID));

				if (!rename($_FILES['attachment']['tmp_name'], $uploadDir . '/' . $destName))
					fatal_lang_error('attach_timeout', 'critical');
]]></search>
			<add><![CDATA[
				// Remove previous attachments this member might have had.
				removeAttachments(array('id_member' => $memID));
]]></add>
		</operation>

		<operation error="ignore">
			<search position="replace"><![CDATA[
				$destinationPath = $uploadDir . '/' . ($file_hash === null ? $destName : $cur_profile['id_attach'] . '_' . $file_hash);
]]></search>
			<add><![CDATA[
				$destinationPath = $uploadDir . '/' . (empty($file_hash) ? $destName : $cur_profile['id_attach'] . '_' . $file_hash);
]]></add>
		</operation>

		<operation error="ignore">
			<search position="replace"><![CDATA[
				@chmod($uploadDir . '/' . $destName, 0644);
]]></search>
			<add><![CDATA[
				@chmod($uploadDir . '/' . $destinationPath, 0644);
]]></add>
		</operation>
	</file>


	<file name="$sourcedir/ManageAttachments.php" error="skip">
		<operation error="ignore">
			<search position="replace"><![CDATA[
			array('text', 'attachmentExtensions', 40),
			array('check', 'attachmentEncryptFilenames'),
]]></search>
			<add><![CDATA[
			array('text', 'attachmentExtensions', 40),
]]></add>
		</operation>

		<operation error="ignore">
			<search position="replace"><![CDATA[
				SELECT a.id_attach, a.id_folder, a.filename, a.file_hash, a.file_hash, a.attachment_type
]]></search>
			<add><![CDATA[
				SELECT a.id_attach, a.id_folder, a.filename, a.file_hash, a.attachment_type
]]></add>
		</operation>
	</file>


	<file name="$sourcedir/Display.php" error="skip">
		<operation error="ignore">
			<search position="replace"><![CDATA[
	// Does this have a mime type?
	if ($mime_type && (isset($_REQUEST['image']) || !in_array($file_ext, array('jpg', 'gif', 'jpeg', 'x-ms-bmp', 'png', 'psd', 'tiff', 'iff'))))
		header('Content-Type: ' . $mime_type);
]]></search>
			<add><![CDATA[
	// IE 6 just doesn't play nice. As dirty as this seems, it works.
	if ($context['browser']['is_ie6'] && isset($_REQUEST['image']))
		unset($_REQUEST['image']);
	// Does this have a mime type?
	elseif ($mime_type && (isset($_REQUEST['image']) || !in_array($file_ext, array('jpg', 'gif', 'jpeg', 'x-ms-bmp', 'png', 'psd', 'tiff', 'iff'))))
		header('Content-Type: ' . strtr($mime_type, array('image/bmp' => 'image/x-ms-bmp')));
]]></add>
		</operation>
	</file>

</modification>
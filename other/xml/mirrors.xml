<?php
	require_once('/home/simple/public_html/community/SSI.php');
	require_once('/home/simple/security/settings_mirror.php');
	if (!isset($smfFunc) && isset($func))
		$smfFunc = $func;

	echo '<?xml version="1.0"?>

<mirror-list>
	<!-- List of mirrors which hold the downloads. -->
	<mirrors>
		<mirror name="www.simplemachines.org">http://www.simplemachines.org/download/index.php/</mirror>
	</mirrors>

	<!-- List of current install releases. -->
	<installs>';
	// get the current versions
	$res = db_query("
		SELECT ver.verName, ver.fileName, ver.public, IFNULL( pkg.access, 1 ) AS access
		FROM {$customize_prefix}smfVersions AS ver
		LEFT JOIN {$download_prefix}packages AS pkg ON ( pkg.filename LIKE CONCAT( ver.fileName, 'install', '%' ) ) 
		WHERE obsolete !=1
		ORDER BY displayOrder DESC", __FILE__, __LINE__);
	while ( $row = mysql_fetch_assoc($res) )
		echo '
		<install access="', $row['access'], '" name="SMF ', $row['verName'], '">', $row['fileName'], '</install>';
	mysql_free_result($res);
		
	echo '	
	</installs>';

	// Lets go and get the languages we are offerring.
	$res = db_query("
		SELECT ver.verName, ver.fileName, pkg.filename
		FROM customize.smfVersions AS ver
		LEFT JOIN downloads.download_packages AS pkg ON ( pkg.filename LIKE CONCAT( ver.fileName, '%' ) AND pkg.release_type =1 ) 
		WHERE obsolete !=1
			AND NOT ISNULL( pkg.filename ) 
		ORDER BY displayOrder DESC, pkg.filename ASC", __FILE__, __LINE__);

	$languages = array();

	while ($row = mysql_fetch_assoc($res))
	{
		$lang = str_replace($row['fileName'], '', $row['filename']);
		if (!isset($languages[$lang]))
			$languages[$lang] = array(
				'name' => $smfFunc['htmlspecialchars']($lang),
				'access' => $row['access'],
				'versions' => array(),
			);
		$languages[$lang]['versions'][] = $row['verName'];
	}

	mysql_free_result($res);

	echo '

	<!-- Language files available. -->
	<languages>';

	foreach($languages AS $language)
		echo '
		<language name="', $language['name'], '" versions="', implode(', ', $language['versions']), '">', $language['name'], '</language>';

	echo '
	</languages>
</mirror-list>';
?>